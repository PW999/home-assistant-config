###############################################################################
#   @author         :   Phillip (P_W999)
#   @date           :   02/05/2021
#   @package        :   Roomba automation
#   @description    :   Presence based automation for Roomba
#   @url            :
#   @credit         :   https://community.home-assistant.io/t/scheduled-timeslot-automation-e-g-vacuum/259147/3
###############################################################################

# Roomba integration can't be placed in packages (UI is favoured method anyaway)

timer:
  # If everybody left, start a countdown. Once the countdown has finished,
  # check everybody's positions, last time the Roomba vacuumed and then
  # decide if it needs to clean or not. It's a bit easier to debug compared to a
  #   for: '00:15:00'
  roomba_countdown:
    name: Delays starting Roomba after leaving home
    duration: 00:05:00

input_datetime:
  roomba_last_clean:
    name: Last time Roomba did a clean job
    has_date: true
    has_time: true

##############################################
# More intelligent roomba automation (8000000009xxx)
##############################################
# NEXT_ID 8
automation:
  - id: '8000000009001'
    alias: Roomba - Update last clean timestamp
    description: Update input with the last time Roomba started cleaning even if started from app
    trigger:
      - platform: state
        entity_id: vacuum.pwroomba
        to: cleaning
    action:
      - service: input_datetime.set_datetime
        data:
          entity_id: input_datetime.roomba_last_clean
          datetime: "{{ now().strftime('%Y-%m-%d %H:%M:%S') }}"

  # - id: '8000000009002'
  #   alias: Roomba - Start countdown
  #   description: Start the countdown once I leave home (but only during the day)
  #   trigger:
  #     - platform: zone
  #       zone: zone.home
  #       entity_id:
  #         - person.phillip
  #       event: leave
  #   condition:
  #     - condition: time
  #       after: '07:00:00'
  #       before: '19:30:00'
  #   action:
  #     service: timer.start
  #     data:
  #       entity_id: timer.roomba_countdown

  - id: '8000000009003'
    alias: Roomba - Stop
    description: Makes Roomba return if I get home or if I am closer to home (or stop the timer)
    trigger:
      - platform: zone
        zone: zone.home
        entity_id:
          - person.phillip
        event: enter
      - platform: zone
        zone: zone.5km_from_home  # FYI, I shrunk it to 2.5 but the zone is still called zone.5km_from_home, don't name your zones like this
        entity_id:
          - person.phillip
        event: enter
      - platform: zone
        zone: zone.mama # I live close to my mom, but if I'm there, there's usually time enough for Roomba to clean
        entity_id:
          - person.phillip
        event: leave
      - platform: zone
        zone: zone.work
        entity_id:
          - person.phillip
        event: leave
      - platform: time
        at: '21:00:00'
    condition:
      - alias: Only when it's running  # return_to_base when already returning stops it
        condition: state
        entity_id: vacuum.pwroomba
        state: cleaning
    action:
      - service: timer.cancel
        data:
          entity_id: timer.roomba_countdown
      - service: vacuum.return_to_base
        data:
          entity_id: vacuum.pwroomba

  - id: '8000000009004'
    alias: Roomba - Start clean
    description: Starts cleaning after timer expired
    trigger:
      platform: event
      event_type: timer.finished
      event_data:
        entity_id: timer.roomba_countdown
    condition:
      - condition: template
        value_template: >
            {% set current_date = now().strftime("%Y-%m-%d") %}
            {% set timeslot_begin = strptime(current_date + " 07:00:00", "%Y-%m-%d %H:%M:%S") %}
            {% set timeslot_end = strptime(current_date + " 20:00:00", "%Y-%m-%d %H:%M:%S") %}
            {% set last_triggered_at = strptime(states('input_datetime.roomba_last_clean'), "%Y-%m-%d %H:%M:%S") %}
            {% set already_triggered_today =  timeslot_begin <= last_triggered_at < timeslot_end %}
            {{ not already_triggered_today }}
      # - condition: or
      #   conditions:
      #     - condition: zone
      #       entity_id:
      #         - person.phillip
      #       zone:
      #         - zone.mama
      #     - condition: not
      #       conditions:
      #         - condition: zone
      #           entity_id:
      #             - person.phillip
      #           zone:
      #             - zone.5km_from_home
    action:
      service: vacuum.start
      data:
        entity_id: vacuum.pwroomba

  # - id: '8000000009005'
  #   alias: Notification - Roomba
  #   description: Send a message when Roomba started
  #   mode: single  # single + delay => make sure it can only send it once every 600s
  #   trigger:
  #     - platform: state
  #       entity_id: vacuum.pwroomba
  #       from: docked
  #       to: cleaning
  #   action:
  #     - service: notify.mobile_app_mi_9t
  #       data:
  #         message: |
  #           Roomba started a clean job at {{ now() }}
  #         title: Roomba
  #     - delay: 600

  # ZIGBEE BUTTON INTEGRATION - lightify_switch_mini_26 is located in the hallway#
  - id: '8000000009006'
    alias: Button - Leave and start Roomba
    description: Use down button of Osram Mini to turn off master switch and schedule a Roomba start
    mode: single
    trigger:
      - platform: event
        event_type: deconz_event
        event_data:
          id: 'lightify_switch_mini_26'
          event: 2002 # short button press
    condition:
      - condition: state
        entity_id: input_boolean.master_switch
        state:  'on'
    action:
      - service: light.toggle
        data:
          entity_id: light.hall_2
          flash: long
      - service: timer.start
        data:
          entity_id: timer.roomba_countdown
      - delay: 120
      - service: input_boolean.turn_off
        data:
          entity_id: input_boolean.master_switch

  # ZIGBEE BUTTON INTEGRATION - lightify_switch_mini_26 is located in the hallway#
  - id: '8000000009007'
    alias: Button - Cancel Roomba
    description: Use down button of Osram Mini to cancel timer and/or return Roomba to it's base
    mode: single
    trigger:
      - platform: event
        event_type: deconz_event
        event_data:
          id: 'lightify_switch_mini_26'
          event: 2003 # long button press (release)
    action:
      - service: light.toggle
        data:
          entity_id: light.hall_2
          flash: long
      - service: timer.cancel
        data:
          entity_id: timer.roomba_countdown
      - service: vacuum.return_to_base
        data:
          entity_id: vacuum.pwroomba